
define('phonesTestData',[], function() {
    var onePhone = [
        {
            "id": "dell-streak-7",
            "name": "Dell Streak 7"
        }
    ];

    var twoPhones = [
        {
            "age": 0,
            "id": "motorola-xoom-with-wi-fi",
            "imageUrl": "img/phones/motorola-xoom-with-wi-fi.0.jpg",
            "name": "Motorola XOOM\u2122 with Wi-Fi",
            "snippet": "The Next, Next Generation\r\n\r\nExperience the future with Motorola XOOM with Wi-Fi, the world's first tablet powered by Android 3.0 (Honeycomb)."
        },
        {
            "age": 1,
            "id": "motorola-xoom",
            "imageUrl": "img/phones/motorola-xoom.0.jpg",
            "name": "MOTOROLA XOOM\u2122",
            "snippet": "The Next, Next Generation\n\nExperience the future with MOTOROLA XOOM, the world's first tablet powered by Android 3.0 (Honeycomb)."
        }
    ];

    var manyPhones = [
        {
            "age": 0,
            "id": "motorola-xoom-with-wi-fi",
            "imageUrl": "img/phones/motorola-xoom-with-wi-fi.0.jpg",
            "name": "Motorola XOOM\u2122 with Wi-Fi",
            "snippet": "The Next, Next Generation\r\n\r\nExperience the future with Motorola XOOM with Wi-Fi, the world's first tablet powered by Android 3.0 (Honeycomb)."
        },
        {
            "age": 1,
            "id": "motorola-xoom",
            "imageUrl": "img/phones/motorola-xoom.0.jpg",
            "name": "MOTOROLA XOOM\u2122",
            "snippet": "The Next, Next Generation\n\nExperience the future with MOTOROLA XOOM, the world's first tablet powered by Android 3.0 (Honeycomb)."
        },
        {
            "age": 2,
            "carrier": "AT&amp;T",
            "id": "motorola-atrix-4g",
            "imageUrl": "img/phones/motorola-atrix-4g.0.jpg",
            "name": "MOTOROLA ATRIX\u2122 4G",
            "snippet": "MOTOROLA ATRIX 4G the world's most powerful smartphone."
        },
        {
            "age": 3,
            "id": "dell-streak-7",
            "imageUrl": "img/phones/dell-streak-7.0.jpg",
            "name": "Dell Streak 7",
            "snippet": "Introducing Dell\u2122 Streak 7. Share photos, videos and movies together. It\u2019s small enough to carry around, big enough to gather around."
        },
        {
            "age": 4,
            "carrier": "Cellular South",
            "id": "samsung-gem",
            "imageUrl": "img/phones/samsung-gem.0.jpg",
            "name": "Samsung Gem\u2122",
            "snippet": "The Samsung Gem\u2122 brings you everything that you would expect and more from a touch display smart phone \u2013 more apps, more features and a more affordable price."
        },
        {
            "age": 5,
            "carrier": "Dell",
            "id": "dell-venue",
            "imageUrl": "img/phones/dell-venue.0.jpg",
            "name": "Dell Venue",
            "snippet": "The Dell Venue; Your Personal Express Lane to Everything"
        },
        {
            "age": 6,
            "carrier": "Best Buy",
            "id": "nexus-s",
            "imageUrl": "img/phones/nexus-s.0.jpg",
            "name": "Nexus S",
            "snippet": "Fast just got faster with Nexus S. A pure Google experience, Nexus S is the first phone to run Gingerbread (Android 2.3), the fastest version of Android yet."
        },
        {
            "age": 7,
            "carrier": "Cellular South",
            "id": "lg-axis",
            "imageUrl": "img/phones/lg-axis.0.jpg",
            "name": "LG Axis",
            "snippet": "Android Powered, Google Maps Navigation, 5 Customizable Home Screens"
        },
        {
            "age": 8,
            "id": "samsung-galaxy-tab",
            "imageUrl": "img/phones/samsung-galaxy-tab.0.jpg",
            "name": "Samsung Galaxy Tab\u2122",
            "snippet": "Feel Free to Tab\u2122. The Samsung Galaxy Tab\u2122 brings you an ultra-mobile entertainment experience through its 7\u201d display, high-power processor and Adobe\u00ae Flash\u00ae Player compatibility."
        },
        {
            "age": 9,
            "carrier": "Cellular South",
            "id": "samsung-showcase-a-galaxy-s-phone",
            "imageUrl": "img/phones/samsung-showcase-a-galaxy-s-phone.0.jpg",
            "name": "Samsung Showcase\u2122 a Galaxy S\u2122 phone",
            "snippet": "The Samsung Showcase\u2122 delivers a cinema quality experience like you\u2019ve never seen before. Its innovative 4\u201d touch display technology provides rich picture brilliance, even outdoors"
        },
        {
            "age": 10,
            "carrier": "Verizon",
            "id": "droid-2-global-by-motorola",
            "imageUrl": "img/phones/droid-2-global-by-motorola.0.jpg",
            "name": "DROID\u2122 2 Global by Motorola",
            "snippet": "The first smartphone with a 1.2 GHz processor and global capabilities."
        },
        {
            "age": 11,
            "carrier": "Verizon",
            "id": "droid-pro-by-motorola",
            "imageUrl": "img/phones/droid-pro-by-motorola.0.jpg",
            "name": "DROID\u2122 Pro by Motorola",
            "snippet": "The next generation of DOES."
        },
        {
            "age": 12,
            "carrier": "AT&amp;T",
            "id": "motorola-bravo-with-motoblur",
            "imageUrl": "img/phones/motorola-bravo-with-motoblur.0.jpg",
            "name": "MOTOROLA BRAVO\u2122 with MOTOBLUR\u2122",
            "snippet": "An experience to cheer about."
        }
    ];

    var onePhoneDetail = {
        "additionalFeatures": "Front Facing 1.3MP Camera",
        "android": {
            "os": "Android 2.2",
            "ui": "Dell Stage"
        },
        "availability": [
            "T-Mobile"
        ],
        "battery": {
            "standbyTime": "",
            "talkTime": "",
            "type": "Lithium Ion (Li-Ion) (2780 mAH)"
        },
        "camera": {
            "features": [
                "Flash",
                "Video"
            ],
            "primary": "5.0 megapixels"
        },
        "connectivity": {
            "bluetooth": "Bluetooth 2.1",
            "cell": "T-mobile HSPA+ @ 2100/1900/AWS/850 MHz",
            "gps": true,
            "infrared": false,
            "wifi": "802.11 b/g"
        },
        "description": "Introducing Dell\u2122 Streak 7. Share photos, videos and movies together. It\u2019s small enough to carry around, big enough to gather around. Android\u2122 2.2-based tablet with over-the-air upgrade capability for future OS releases.  A vibrant 7-inch, multitouch display with full Adobe\u00ae Flash 10.1 pre-installed.  Includes a 1.3 MP front-facing camera for face-to-face chats on popular services such as Qik or Skype.  16 GB of internal storage, plus Wi-Fi, Bluetooth and built-in GPS keeps you in touch with the world around you.  Connect on your terms. Save with 2-year contract or flexibility with prepaid pay-as-you-go plans",
        "display": {
            "screenResolution": "WVGA (800 x 480)",
            "screenSize": "7.0 inches",
            "touchScreen": true
        },
        "hardware": {
            "accelerometer": true,
            "audioJack": "3.5mm",
            "cpu": "nVidia Tegra T20",
            "fmRadio": false,
            "physicalKeyboard": false,
            "usb": "USB 2.0"
        },
        "id": "dell-streak-7",
        "images": [
            "img/phones/dell-streak-7.0.jpg",
            "img/phones/dell-streak-7.1.jpg",
            "img/phones/dell-streak-7.2.jpg",
            "img/phones/dell-streak-7.3.jpg",
            "img/phones/dell-streak-7.4.jpg"
        ],
        "name": "Dell Streak 7",
        "sizeAndWeight": {
            "dimensions": [
                "199.9 mm (w)",
                "119.8 mm (h)",
                "12.4 mm (d)"
            ],
            "weight": "450.0 grams"
        },
        "storage": {
            "flash": "16000MB",
            "ram": "512MB"
        }
    };

    return {
        onePhone: onePhone,
        twoPhones: twoPhones,
        manyPhones: manyPhones,
        onePhoneDetail: onePhoneDetail
    }
});

define('lib/jquery',[], function() {
    if (typeof window !== 'undefined') {
        return window.$;
    }
});

define('lib/angular', [], function () {
    var angular;
    if (typeof window !== 'undefined') {
        angular = window.angular;
    }

    function controller(name, ctrl) {
        window[name] = ctrl;
    }

    angular.controller = controller;

    return angular;
});

define('app/PhoneCtrl',["lib/angular"], function(angular) {

    function PhoneCtrl(phoneService) {
        var self = this;
        this.phonesListState = {
            sortDescend : false,
            search : null
        };
        this.phoneService = phoneService;
        this.phones = [];
        phoneService.phones().done(function(phones) {
            self.phones = phones;
        });
    }

    PhoneCtrl.prototype = {
        pagedPhones : function() {
            var sort = this.phonesListState.sortDescend ? '-' : '+';
            sort += "name";
            var search = null;
            if (this.phonesListState.search) {
                search = {name: this.phonesListState.search};
            }
            return angular.Array.paged(this.phones, search, sort);
        },
        selectPhone: function(phone) {
            var self = this;
            this.phoneService.phone(phone.id).done(function(phone) {
                self.selectedPhone = phone;
            });
        }
    };

    PhoneCtrl.$inject = ["phoneService"];

    angular.controller('PhoneCtrl', PhoneCtrl);

    return PhoneCtrl;
});

define('unit/PhoneCtrlSpec',[
    'phonesTestData',
    'lib/jquery',
    'app/PhoneCtrl'], function(testData, $, PhoneCtrl) {
    describe('PhoneCtrl', function() {
        var phonesSpy, phoneSpy;
        beforeEach(function() {
            phonesSpy = jasmine.createSpy('phones');
            phoneSpy = jasmine.createSpy('phone');
        });


        function createCtrl(phones, phone) {
            var phonesPromise = $.Deferred();
            phonesPromise.resolve(phones);
            phonesSpy.andReturn(phonesPromise);
            var phonePromise = $.Deferred();
            phonePromise.resolve(phone);
            phoneSpy.andReturn(phonePromise);
            return new PhoneCtrl({phones: phonesSpy, phone: phoneSpy});
        }

        it('should contain a phones property with the expected list of phones', function() {
            var ctrl = createCtrl(testData.twoPhones);
            expect(ctrl.phones).toEqual(testData.twoPhones);
        });

        it('should return a paged list for pagedPhones', function() {
            var ctrl = createCtrl(testData.manyPhones);
            expect(ctrl.pagedPhones().length).toEqual(10);

        });

        it('should return a filtered list for pagedPhones', function() {
            var ctrl = createCtrl(testData.twoPhones);
            ctrl.phonesListState.search = 'Wi';
            expect(ctrl.pagedPhones().length).toEqual(1);
        });

        it('should return a sorted list for pagedPhones', function() {
            var ctrl = createCtrl(testData.twoPhones);
            ctrl.phonesListState.sortDescend = true;
            expect(ctrl.pagedPhones()[0].name).toEqual("Motorola XOOM\u2122 with Wi-Fi");
            ctrl.phonesListState.sortDescend = false;
            expect(ctrl.pagedPhones()[0].name).toEqual("MOTOROLA XOOM\u2122");
        });

        it('should load the details of the selected phone', function() {
            var ctrl = createCtrl([], testData.onePhoneDetail);
            ctrl.selectPhone({id: 'motorola-xoom-with-wi-fi'});
            expect(ctrl.selectedPhone).toBe(testData.onePhoneDetail);
        })
    });
});

define('app/phoneService',["lib/angular", "lib/jquery"], function (angular, $) {

    function phoneServiceFactory($xhr) {

        function phones() {
            var res = $.Deferred();
            $xhr('GET', 'phones/phones.json', res.resolve, res.reject);
            return res.pipe(function (code, data) {
                return data;
            });
        }

        function phone(id) {
            var res = $.Deferred();
            $xhr('GET', 'phones/' + id + '.json', res.resolve, res.reject);
            return res.pipe(function (code, data) {
                return data;
            });
        }

        return {
            phones:phones,
            phone:phone
        }
    }

    phoneServiceFactory.$inject = ['$xhr'];

    angular.service("phoneService", phoneServiceFactory);

    return phoneServiceFactory;

});

define('unit/phoneServiceSpec',['lib/jquery', 'app/phoneService'], function($, phoneServiceFactory) {
    describe('phoneService', function() {
        var mockXhr, service;
        beforeEach(function() {
            mockXhr = jasmine.createSpy('xhr');
            service = phoneServiceFactory(mockXhr);
        });

        it('should call and return phones/phones.json as promise', function() {
            var phones = [
                {test: true}
            ];

            var serviceResult;
            service.phones().done(function(res) {
                serviceResult = res;
            });
            mockXhr.argsForCall[0][2](200, phones);
            expect(serviceResult).toEqual(phones);

        });

        it('should call and return phones/[id].json as promise', function() {
            var phone = [
                {test: true}
            ];
            var serviceResult;
            service.phone().done(function(res) {
                serviceResult = res;
            });
            mockXhr.argsForCall[0][2](200, phone);
            expect(serviceResult).toEqual(phone);

        });
    });
});

/**
 * Contains all the unit-tests.
 */
require([
    'unit/PhoneCtrlSpec',
    'unit/phoneServiceSpec'
]);

define("unit-tests", function(){});
